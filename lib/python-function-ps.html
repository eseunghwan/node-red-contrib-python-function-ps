
<script type="text/javascript">
    RED.nodes.registerType("python-function-ps", {
        category: "function",
        color: "#fdd0a2",
        defaults: {
            name: { value: "" },
            pythonPathType: { value: "local" },
            pythonPath: { value: "python3" }, globalPythonName: { value: "" },
            fnCode: { value: "\n# user code here.\n\nreturn msg" },
            outputs: { value: 1 }  // Ofuscated way to persist the number of outputs of the node
        },
        inputs: 1,
        outputs: 1,
        icon: "function.png",
        label: function() {
            return this.name;
        },
        oneditprepare: function() {
            $( "#node-input-outputs" ).spinner({ min:1 });

            this.editor = RED.editor.createEditor({
                id: "node-input-fnCode",
                mode: "ace/mode/python",
                value: this.fnCode,
                focus: true
            });
            // var langTools = ace.require("ace/ext/language_tools");
            // this.editor = ace.edit("node-input-fnCode-editor");
            // this.editor.getSession().setMode("ace/mode/python");
            // this.editor.setValue($("#node-input-fnCode").val(), -1);
            // this.editor.setOptions({
            //         enableBasicAutocompletion: true,
            //         enableLiveAutocompletion: true,
            //         highlightSelectedWord: true,
            //         useSoftTabs: true,
            //         tabSize: 4,
            // });
            // var noderedKeywords = [
            //     "msg", 'msg["payload"]',
            //     "node", "node.globals",
            //     "node.log", "node.warn", "node.error", "node.status"
            // ];
            // this.editor.completers.push({
            //     getCompletions: function (state, session, pos, prefix, callback) {
            //         callback(null, noderedKeywords.map(function (keyword) {
            //             return {
            //                 name: keyword,
            //                 value: keyword,
            //                 score: 0,
            //                 meta: "Node-RED"
            //             };
            //         }));
            //     }
            // });
            // this.editor.focus();

            $("#node-input-typed-pythonPath").typedInput({
                default: "local",
                types: [
                    { value: "local", label: "local:", hasValue: true },
                    { value: "global", label: "global.", hasValue: true }
                ],
                typeField: $("#node-input-pythonPathType")
            });

            $("#node-input-typed-pythonPath").typedInput("type", this.pythonPathType);
            $("#node-input-typed-pythonPath").typedInput("value", this.pythonPathType == "local" ? this.pythonPath : this.globalPythonName);

            var lastPathType = this.pythonPathType;
            $("#node-input-typed-pythonPath").on("change", function() {
                if ($("#node-input-typed-pythonPath").typedInput("type") != lastPathType) {
                    lastPathType = $("#node-input-typed-pythonPath").typedInput("type");

                    $("#node-input-typed-pythonPath").typedInput(
                        "value",
                        $("#node-input-typed-pythonPath").typedInput("type") == "local" ? $("#node-input-pythonPath").val() : $("#node-input-globalPythonName").val()
                    );
                }
            });
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditsave: function() {
            $("#node-input-fnCode").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;

            if ($("#node-input-typed-pythonPath").typedInput("type") == "local") {
                $("#node-input-pythonPath").val($("#node-input-typed-pythonPath").typedInput("value"));
            }
            else {
                $("#node-input-globalPythonName").val($("#node-input-typed-pythonPath").typedInput("value"));
            }
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i = 0; i<rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }

            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height", `${height}px`);
            this.editor.resize();
        }
    });
</script>

<script type="text/html" data-template-name="python-function-ps">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span>Name</span></label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-typed-pythonPath"><i class="fa fa-list"></i> <span>Python Path</span></label>
        <input id="node-input-typed-pythonPath" type="text" style="width:70%;">
        <input id="node-input-pythonPath" type="hidden">
        <input id="node-input-globalPythonName" type="hidden">
        <input id="node-input-pythonPathType" type="hidden">
    </div>
    <div class="form-row" style="margin-bottom: 0px;">
        <label for="node-input-fnCode"><i class="fa fa-wrench"></i> <span>Function</span></label>
        <!-- <input type="hidden" id="node-input-fnCode" autofocus="autofocus"> -->
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height:250px;min-height:150px;" class="node-text-editor" id="node-input-fnCode"></div>
    </div>
    <div class="form-row">
        <label for="node-input-outputs"><i class="fa fa-random"></i> <span>Outputs</span></label>
        <input id="node-input-outputs" style="width: 60px;" value="1">
    </div>
</script>
